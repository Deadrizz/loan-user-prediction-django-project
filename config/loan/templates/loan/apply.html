{% extends "loan/base.html" %}
{% block title %}–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É{% endblock %}

{% block content %}
<h2>üìã –§–æ—Ä–º–∞ –∫—Ä–µ–¥–∏—Ç–Ω–æ—ó –∑–∞—è–≤–∫–∏</h2>
<p>–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è –Ω–∏–∂—á–µ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∫—Ä–µ–¥–∏—Ç—É.</p>

<form id="loan-form" onsubmit="return false;" style="margin-top:15px;">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">

    <label>–°—Ç–∞—Ç—å
      <select name="gender" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—å --</option>
        <option value="Male">–ß–æ–ª–æ–≤—ñ—á–∞</option>
        <option value="Female">–ñ—ñ–Ω–æ—á–∞</option>
      </select>
    </label>

    <label>–°—ñ–º–µ–π–Ω–∏–π —Å—Ç–∞–Ω
      <select name="married" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
        <option value="Yes">–û–¥—Ä—É–∂–µ–Ω–∏–π / –ó–∞–º—ñ–∂–Ω—è</option>
        <option value="No">–ù–µ–æ–¥—Ä—É–∂–µ–Ω–∏–π / –ù–µ–∑–∞–º—ñ–∂–Ω—è</option>
      </select>
    </label>

    <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É—Ç—Ä–∏–º–∞–Ω—Ü—ñ–≤
      <select name="dependents" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
        <option value="0">0 ‚Äî –Ω–µ–º–∞—î</option>
        <option value="1">1 —É—Ç—Ä–∏–º–∞–Ω–µ—Ü—å</option>
        <option value="2">2 —É—Ç—Ä–∏–º–∞–Ω—Ü—ñ</option>
        <option value="3+">3 –∞–±–æ –±—ñ–ª—å—à–µ</option>
      </select>
    </label>

    <label>–û—Å–≤—ñ—Ç–∞
      <select name="education" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–µ–Ω—å –æ—Å–≤—ñ—Ç–∏ --</option>
        <option value="Graduate">–í–∏—â–∞</option>
        <option value="Not Graduate">–°–µ—Ä–µ–¥–Ω—è</option>
      </select>
    </label>

    <label>–°–∞–º–æ–∑–∞–π–Ω—è—Ç—ñ—Å—Ç—å
      <select name="self_employed" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
        <option value="Yes">–¢–∞–∫</option>
        <option value="No">–ù—ñ</option>
      </select>
    </label>

    <label>–û—Å–Ω–æ–≤–Ω–∏–π –¥–æ—Ö—ñ–¥ (‚Ç¥)
      <input type="number" name="applicant_income" min="0" required placeholder="–ù–∞–ø—Ä. 40000">
      <small>–í–∫–∞–∂—ñ—Ç—å —Å–≤—ñ–π —â–æ–º—ñ—Å—è—á–Ω–∏–π –¥–æ—Ö—ñ–¥.</small>
    </label>

    <label>–î–æ—Ö—ñ–¥ —Å–ø—ñ–≤–∑–∞—è–≤–Ω–∏–∫–∞ (‚Ç¥)
      <input type="number" name="coapplicant_income" min="0" placeholder="–ù–∞–ø—Ä. 15000">
      <small>–Ø–∫—â–æ –ø–æ–¥–∞—î—Ç–µ –∑–∞—è–≤–∫—É —Ä–∞–∑–æ–º —ñ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º ‚Äî –≤–∫–∞–∂—ñ—Ç—å –π–æ–≥–æ –¥–æ—Ö—ñ–¥. –Ü–Ω–∞–∫—à–µ –∑–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º.</small>
    </label>

    <label>–°—É–º–∞ –∫—Ä–µ–¥–∏—Ç—É (—Ç–∏—Å. ‚Ç¥)
      <input type="number" name="loan_amount" min="0" step="0.01" required placeholder="–ù–∞–ø—Ä. 250.5">
      <small>–°–∫—ñ–ª—å–∫–∏ –≥—Ä–æ—à–µ–π –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–∑–∏—á–∏—Ç–∏.</small>
    </label>

    <label>–¢–µ—Ä–º—ñ–Ω –∫—Ä–µ–¥–∏—Ç—É (–≤ –º—ñ—Å—è—Ü—è—Ö)
      <input type="number" name="loan_amount_term" min="1" required placeholder="–ù–∞–ø—Ä. 360">
      <small>–ù–∞ —è–∫–∏–π —Ç–µ—Ä–º—ñ–Ω –≤–∏ —Ö–æ—á–µ—Ç–µ –≤–∑—è—Ç–∏ –∫—Ä–µ–¥–∏—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 360 –º—ñ—Å—è—Ü—ñ–≤ = 30 —Ä–æ–∫—ñ–≤).</small>
    </label>

    <label>–¢–∏–ø –º—ñ—Å—Ü–µ–≤–æ—Å—Ç—ñ
      <select name="property_area" required>
        <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
        <option value="Urban">–ú—ñ—Å—å–∫–∞</option>
        <option value="Rural">–°—ñ–ª—å—Å—å–∫–∞</option>
        <option value="Semiurban">–ü–µ—Ä–µ–¥–º—ñ—Å—Ç—è</option>
      </select>
    </label>
  </div>

  <button id="submit-btn" style="margin-top:18px;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
</form>

<section id="result" style="margin-top:20px;display:none;">
  <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑—É</h3>
  <p id="result-text"></p>
</section>
{% endblock %}

{% block scripts %}
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  const form = document.getElementById('loan-form');
  const resultBox = document.getElementById('result');
  const resultText = document.getElementById('result-text');
  const submitBtn = document.getElementById('submit-btn');

  submitBtn.addEventListener('click', async () => {
    const data = Object.fromEntries(new FormData(form).entries());
    data.applicant_income = Number(data.applicant_income);
    data.coapplicant_income = data.coapplicant_income ? Number(data.coapplicant_income) : 0;
    data.loan_amount = Number(data.loan_amount);
    data.loan_amount_term = Number(data.loan_amount_term);

    try {
      const resp = await fetch("/api/loans/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(data),
        credentials: "same-origin"
      });

      const payload = await resp.json();
      resultBox.style.display = 'block';

      if (!resp.ok) {
        resultText.textContent = "–ü–æ–º–∏–ª–∫–∞: " + (payload.detail || JSON.stringify(payload));
        resultText.style.color = "crimson";
        return;
      }

      const approved = payload.predicted_approved;
      const proba = payload.predicted_probability;

      resultText.style.color = approved ? "green" : "crimson";
      resultText.textContent = approved
        ? `‚úÖ –í—ñ—Ç–∞—î–º–æ! –ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Å—Ö–≤–∞–ª–µ–Ω–Ω—è: ${(proba * 100).toFixed(1)}%.`
        : `‚ùå –ù–∞ –∂–∞–ª—å, –∑–∞—è–≤–∫–∞, –π–º–æ–≤—ñ—Ä–Ω–æ, –±—É–¥–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞ (${(proba * 100).toFixed(1)}%).`;

      form.reset();
    } catch (e) {
      resultBox.style.display = 'block';
      resultText.style.color = "crimson";
      resultText.textContent = "–°–µ—Ç–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞: " + e.message;
    }
  });
</script>
{% endblock %}